#!/usr/bin/env python3
"""
ãƒãƒ¼ã‚«ãƒ¼ GTO åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
ãƒãƒ³ãƒ‰ID ã‚’å…¥åŠ› â†’ åŒ…æ‹¬çš„ãª GTO åˆ†æãƒ¬ãƒãƒ¼ãƒˆ ã‚’ç”Ÿæˆ
"""

import json
from pathlib import Path
from datetime import datetime
import sys

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
sys.path.insert(0, str(Path(__file__).parent))
from gto_evaluator import GTOEvaluator


class PokerGTOAgent:
    """GTO å¯¾å¿œãƒãƒ¼ã‚«ãƒ¼åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""
    
    def __init__(self):
        self.data_dir = Path(__file__).parent.parent / 'data'
        self.reports_dir = Path(__file__).parent.parent / 'reports'
        self.hands_data = []
    
    def analyze_hands(self, hand_ids: list):
        """
        è¤‡æ•°ã®ãƒãƒ³ãƒ‰IDã‹ã‚‰åŒ…æ‹¬çš„ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        
        Args:
            hand_ids: ãƒãƒ³ãƒ‰ID ã®ãƒªã‚¹ãƒˆ
        """
        
        print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         ğŸ° GTO å¯¾å¿œãƒãƒ¼ã‚«ãƒ¼åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š åˆ†æã‚’å®Ÿè¡Œä¸­...
""")
        
        # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ¬æ¥ã¯ API ã‹ã‚‰å–å¾—ï¼‰
        sample_hands = self._generate_sample_analysis(hand_ids)
        
        # åˆ†æå®Ÿè¡Œ
        report = self._generate_gto_report(sample_hands)
        
        # ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
        self._save_report(report)
        
        print("\nâœ… åˆ†æå®Œäº†ï¼\n")
        return report
    
    def _generate_sample_analysis(self, hand_ids: list) -> list:
        """ã‚µãƒ³ãƒ—ãƒ«åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆï¼ˆå®Ÿè£…ç”¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰"""
        
        # å®Ÿéš›ã«ã¯ã€å„ hand_id ã«å¯¾ã—ã¦ API ã‹ã‚‰è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        sample_data = [
            {
                'hand_id': hand_ids[0] if hand_ids else 'J674e1buxOGyzZB15uwY',
                'position': 'BTN',
                'hand': 'AK',
                'action': 'raise',
                'profit_bb': -50,
                'result': 'LOSE',
                'opponent_type': 'TAG',
            },
            {
                'hand_id': hand_ids[1] if len(hand_ids) > 1 else 'QZVSZQq4RedGPnlQZ3gs',
                'position': 'MP',
                'hand': 'QQ',
                'action': 'raise',
                'profit_bb': 75,
                'result': 'WIN',
                'opponent_type': 'FISH',
            },
        ]
        
        return sample_data
    
    def _generate_gto_report(self, hands_data: list) -> str:
        """GTO åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""
        
        report = f"""# ğŸ° GTO å¯¾å¿œãƒãƒ¼ã‚«ãƒ¼åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**ç”Ÿæˆæ—¥æ™‚:** {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}

---

## ğŸ“Š åˆ†æçµæœã‚µãƒãƒªãƒ¼

åˆ†æå¯¾è±¡: {len(hands_data)} ãƒãƒ³ãƒ‰

"""
        
        # å„ãƒãƒ³ãƒ‰ã®åˆ†æ
        gto_correct_count = 0
        
        for i, hand in enumerate(hands_data, 1):
            position = hand.get('position', 'N/A')
            hand_name = hand.get('hand', 'N/A')
            action = hand.get('action', 'N/A')
            profit = hand.get('profit_bb', 0)
            result = hand.get('result', 'N/A')
            
            # GTO è©•ä¾¡
            evaluation = GTOEvaluator.evaluate_action(
                position, hand_name, action, hand
            )
            
            if evaluation['gto_alignment'] == 'correct':
                gto_correct_count += 1
            
            # ãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ 
            report += f"""
### ãƒãƒ³ãƒ‰ {i}: {hand_name}

**åŸºæœ¬æƒ…å ±:**
- ãƒãƒ³ãƒ‰ID: {hand.get('hand_id', 'N/A')}
- ãƒã‚¸ã‚·ãƒ§ãƒ³: {position}
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: {action}
- çµæœ: {result} ({profit:+.1f}bb)
- å¯¾æˆ¦ç›¸æ‰‹: {hand.get('opponent_type', 'N/A')}

**GTO è©•ä¾¡:**
- {evaluation['evaluation']}
- **{evaluation['explanation']}**

**æ–‡è„ˆä»˜ãã‚¢ãƒ‰ãƒã‚¤ã‚¹:**
{evaluation['advice']}

---

"""
        
        # ã‚µãƒãƒªãƒ¼
        report += f"""
## ğŸ¯ ç·åˆè©•ä¾¡

- **GTO æ•´åˆç‡:** {gto_correct_count}/{len(hands_data)} ({gto_correct_count/len(hands_data)*100:.0f}%)
- **ä¸»ãªãƒªãƒ¼ã‚¯:** ä½ç½®åˆ¥æˆ¦ç•¥ã®æ”¹å–„ãŒå¿…è¦
- **æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:** å¼±ã„ãƒãƒ³ãƒ‰ã® fold ç‡ã‚’ä¸Šã’ã‚‹

## ğŸ’¡ æœ¬è³ªçš„ãªæ”¹å–„ææ¡ˆ

1. **çŸ­æœŸçš„ãªçµæœã«å·¦å³ã•ã‚Œãªã„**
   - ãƒãƒ¼ã‚«ãƒ¼ã¯ç¢ºç‡ã®ã‚²ãƒ¼ãƒ 
   - è² ã‘ã¦ã„ã¦ã‚‚åˆ¤æ–­ãŒæ­£ã—ã‘ã‚Œã°ç¶™ç¶š

2. **GTO åŸºæº–ã‚’å­¦ç¿’**
   - å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã®æ¨å¥¨ãƒ¬ãƒ³ã‚¸ã‚’æš—è¨˜
   - é€¸è„±æ™‚ã¯ç†ç”±ã‚’æ˜ç¢ºã«

3. **å®šæœŸçš„ãªå¾©ç¿’**
   - æ¯é€± 50 ãƒãƒ³ãƒ‰ã‚’åˆ†æ
   - æœˆ 1 å›ã®åŒ…æ‹¬ãƒ¬ãƒ“ãƒ¥ãƒ¼

---

*Generated by Poker GTO Agent v1.0*
*Last Updated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*
"""
        
        return report
    
    def _save_report(self, report: str):
        """ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
        
        self.reports_dir.mkdir(exist_ok=True)
        
        report_file = self.reports_dir / 'GTO_ANALYSIS_REPORT.md'
        
        with open(report_file, 'w', encoding='utf-8') as f:
            f.write(report)
        
        print(f"âœ“ ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜: {report_file}")
        print(f"\nğŸ“– ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º:")
        print(f"  open {report_file}\n")


def main():
    """ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"""
    
    import argparse
    
    parser = argparse.ArgumentParser(description='GTO å¯¾å¿œãƒãƒ¼ã‚«ãƒ¼åˆ†æ')
    parser.add_argument('hand_ids', nargs='*', help='åˆ†æã™ã‚‹ãƒãƒ³ãƒ‰ID')
    
    args = parser.parse_args()
    
    agent = PokerGTOAgent()
    report = agent.analyze_hands(args.hand_ids)
    
    print(report)


if __name__ == '__main__':
    main()
